# 馬券管理システム データ構造設計書 (Data Structure Schema)

## 1. データベーススキーマ (PostgreSQL)

**tickets** **テーブルの定義です。**

**code**SQL

```
CREATE TABLE public.tickets (
  -- 識別子
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  race_id text NOT NULL,                    -- 例: "202511300512" (文字列として扱う)
  receipt_unique_id text NULL,              -- 外部システム由来のユニークID
  
  -- 投票内容
  bet_type text NOT NULL,                   -- 式別 (Enum: BetType)
  buy_type text NOT NULL,                   -- 方式 (Enum: BuyType)
  content jsonb NOT NULL,                   -- 買い目詳細 (JSON構造は後述)
  
  -- 金額情報
  amount_per_point integer NOT NULL,        -- 1点あたりの金額
  total_points integer NOT NULL,            -- 購入点数
  total_cost integer NOT NULL,              -- 合計金額 (amount * points)
  
  -- 結果・ステータス
  status text NULL DEFAULT 'PENDING'::text, -- 状態 (Enum: BetStatus)
  payout integer NULL DEFAULT 0,            -- 払戻金
  
  -- システム管理情報
  source text NULL DEFAULT 'IPAT_RECENT'::text, -- データ出自 (Enum: SourceType)
  mode text NULL DEFAULT 'REAL'::text,      -- モード (REAL / AIR)
  created_at timestamp with time zone NULL DEFAULT now(),
  
  -- 制約
  CONSTRAINT tickets_pkey PRIMARY KEY (id),
  CONSTRAINT tickets_receipt_unique_id_key UNIQUE (receipt_unique_id),
  CONSTRAINT tickets_race_id_fkey FOREIGN KEY (race_id) REFERENCES races (id),
  CONSTRAINT tickets_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id)
) TABLESPACE pg_default;
```

---

## 2. データ型・Enum定義

**各カラムで使用する値の定義です。**

### 2.1 データソース (**SourceType**)

**source** **カラムの値。データの信頼性と出自を区別します。**

* **IPAT_RECENT**: スマホ版投票サイト等の「当日・直近」履歴由来（速報値）。
* **IPAT_CSV**: 投票照会サービスの過去履歴CSV由来（確報値）。

### 2.2 式別 (**BetType**)

**bet_type** **カラムの値。**

* **WIN** **(単勝)**
* **PLACE** **(複勝)**
* **BRACKET_QUINELLA** **(枠連)**
* **QUINELLA** **(馬連)**
* **QUINELLA_PLACE** **(ワイド)**
* **EXACTA** **(馬単)**
* **TRIO** **(3連複)**
* **TRIFECTA** **(3連単)**

### 2.3 購入方式 (**BuyType**)

**buy_type** **カラムの値。**

* **NORMAL** **(通常・バラ買い)**
* **BOX** **(ボックス)**
* **FORMATION** **(フォーメーション)**
* **NAGASHI** **(流し)**

---

## 3. JSONデータ構造 (**content**)

**content** **カラム（JSONB）の構造定義です。**
流し投票における「着順指定」を **positions** **で表現します。**

### 3.1 TypeScript インターフェース

**code**TypeScript

```
interface BetContent {
  type: BetType;       // 親カラムのbet_typeと同一
  method: BuyType;     // 親カラムのbuy_typeと同一
  multi: boolean;      // マルチ投票フラグ (主にNAGASHIで使用、他はfalse)
  
  /**
   * 選択馬番の配列。
   * NORMAL/BOX: [["01", "02"]] のように1要素目のみ使用
   * FORMATION: [["01"], ["02", "03"]] のように着順(頭目)ごとに配列が分かれる
   * NAGASHI: 原則空配列 []
   */
  selections: string[][]; 

  /**
   * 流しの「軸馬」リスト (NAGASHIのみ使用)
   */
  axis: string[];
  
  /**
   * 流しの「相手馬」リスト (NAGASHIのみ使用)
   */
  partners: string[];
  
  /**
   * 軸馬の固定着順リスト (NAGASHIかつ着順指定がある場合のみ使用)
   * axisのインデックスと1対1で対応する。
   * 値: 1=1着固定, 2=2着固定, 3=3着固定
   * 例: axis=['05'] で positions=[1] なら「5番を1着固定」
   */
  positions: number[]; 
}
```

---

## 4. JSONデータ格納パターン (Examples)

**開発時のテストデータやバリデーションの参考となる実例です。**

### パターンA: 3連単 1着固定流し (NAGASHI)

**「軸: 5番(1着) / 相手: 1, 2, 3番」**

**code**JSON

```
{
  "type": "TRIFECTA",
  "method": "NAGASHI",
  "multi": false,
  "axis": ["05"],
  "partners": ["01", "02", "03"],
  "positions": [1], 
  "selections": []
}
```

> **解説**: **positions: [1]** **は、**axis[0] **である** **"05"** **が** **1着** **に固定されていることを示します。**

### パターンB: 3連単 2頭軸流し・着順指定あり (NAGASHI)

**「軸: 5番(1着), 6番(2着) / 相手: 1, 2, 3番」**

**code**JSON

```
{
  "type": "TRIFECTA",
  "method": "NAGASHI",
  "multi": false,
  "axis": ["05", "06"],
  "partners": ["01", "02", "03"],
  "positions": [1, 2],
  "selections": []
}
```

> **解説**: **positions** **の並び順は** **axis** **と対応します。**axis[0]**="05"→1着,** **axis[1]**="06"→2着 となります。

### パターンC: 3連単 1頭軸マルチ (NAGASHI)

**「軸: 5番(着順不問) / 相手: 1, 2, 3番 / マルチ投票」**

**code**JSON

```
{
  "type": "TRIFECTA",
  "method": "NAGASHI",
  "multi": true,
  "axis": ["05"],
  "partners": ["01", "02", "03"],
  "positions": [],
  "selections": []
}
```

> **解説**: マルチ投票(**multi: true**)の場合、着順は固定されないため **positions** **は空配列となります。**

### パターンD: 3連単 フォーメーション (FORMATION)

**「1着: 5,6 / 2着: 5,6,10 / 3着: 1,2,3,10」**

**code**JSON

```
{
  "type": "TRIFECTA",
  "method": "FORMATION",
  "multi": false,
  "axis": [],
  "partners": [],
  "positions": [],
  "selections": [
    ["05", "06"],             // 1着目の候補
    ["05", "06", "10"],       // 2着目の候補
    ["01", "02", "03", "10"]  // 3着目の候補
  ]
}
```

### パターンE: 馬連 通常・バラ買い (NORMAL)

**「5-10」**

**code**JSON

```
{
  "type": "QUINELLA",
  "method": "NORMAL",
  "multi": false,
  "axis": [],
  "partners": [],
  "positions": [],
  "selections": [
    ["05", "10"]
  ]
}
```
