# 画像認識バックエンド要件定義書

## 概要
フロントエンドから送信された馬券・投票画面の画像をGemini 3.0 Flash APIを用いて解析し、アプリ内で利用可能な構造化データとして返却するAPIの要件。

## エンドポイント仕様

- **URL**: `POST /analyze/image` (Cloud Run上のバックエンド)
- **Content-Type**: `multipart/form-data`

### リクエストパラメータ
| パラメータ名 | 型 | 必須 | 説明 |
| --- | --- | --- | --- |
| `file` | File | Yes | 解析対象の画像ファイル (JPEG, PNG, WEBP等) |

※ フロントエンド側で複数枚アップロードに対応するが、バックエンドへのリクエストは**画像1枚につき1リクエスト**とする（並列処理はフロントエンドで制御）。

### レスポンス仕様 (JSON)

Geminiからの解析結果を、以下のJSONフォーマットに正規化して返却すること。
1枚の画像に複数の投票内容が含まれる場合があるため、配列で返却する。

```json
{
  "results": [
    {
      "raw_text": "抽出された生のテキスト（デバッグ用）",
      "confidence": 0.95, // 解析の確信度 (0.0 - 1.0)
      "data": {
        "date": "2025-12-21", // YYYY-MM-DD形式。不明な場合は null
        "place": "06",        // 競馬場コード (JRAコード準拠)。不明な場合は null
        "race_number": 11,    // レース番号 (1-12)。不明な場合は null
        "bet_type": "TRIFECTA", // 式別コード (後述)。不明な場合は null
        "method": "FORMATION",  // 方式コード (後述)。不明な場合は null
        "selections": [         // 買い目配列。不明な場合は null
          ["01", "02"],         // 1着/1頭目
          ["03", "04"],         // 2着/2頭目
          ["05"]                // 3着/3頭目
        ],
        "axis": [],             // ながし時の軸馬 (method=NAGASHIの場合)
        "partners": [],         // ながし時の相手馬 (method=NAGASHIの場合)
        "positions": [],        // ながし時の軸馬着順指定 (method=NAGASHIの場合)。例: [1] (1着軸), [2] (2着軸)
        "multi": false,         // マルチ投票かどうか
        "amount": 100           // 1点あたりの金額。不明な場合は null
      }
    }
  ]
}

## データ正規化ルール
      }
    }
  ]
}
```

## データ正規化ルール

### 1. 式別コード (`bet_type`)
Geminiが読み取った文字列を以下のコードに変換する。

| 日本語表記 | コード |
| --- | --- |
| 単勝 | `WIN` |
| 複勝 | `PLACE` |
| 枠連 | `BRACKET_QUINELLA` |
| 馬連 | `QUINELLA` |
| ワイド | `QUINELLA_PLACE` |
| 馬単 | `EXACTA` |
| 3連複 | `TRIO` |
| 3連単 | `TRIFECTA` |

### 2. 方式コード (`method`)
| 日本語表記 | コード |
| --- | --- |
| 通常, ボックス以外 | `NORMAL` |
| ボックス | `BOX` |
| フォーメーション | `FORMATION` |
| ながし | `NAGASHI` |

### 3. 競馬場コード (`place`)
主要なJRA競馬場コードへの変換を行う。
(例: 中山 -> "06", 東京 -> "05", 阪神 -> "09", 京都 -> "08" 等)

## エラーハンドリング
- 画像から馬券情報が全く読み取れなかった場合でも、400エラーではなく、空の `results` 配列または `data` の各フィールドが `null` の結果を返すこと（フロントエンド側で「解析不能」として扱うため）。
- サーバー内部エラー（Gemini APIダウン等）の場合は 500 を返す。

## Gemini プロンプトの指針
- 画像内のテキストをOCRするだけでなく、文脈から「日付」「レース番号」「式別」を特定するように指示する。
- 特に「フォーメーション」や「ながし」の場合の買い目の構造（1着・2着・3着の区別）を正確に抽出するよう強調する。
